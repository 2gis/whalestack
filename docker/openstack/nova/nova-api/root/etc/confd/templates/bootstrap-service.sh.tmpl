#!/usr/bin/env bash
# Generated by confd

source $DGIS_OPENSTACK_SCRIPTS_PATH/common.sh
source /openrc.sh

wait_for_endpoint $OS_SERVICE_ENDPOINT 1 10

nova-manage db sync

keystone user-create \
    --name nova \
    --tenant service \
    --pass {{ getv "/services/nova/config/service-password" }}

keystone user-role-add \
    --user nova \
    --role admin \
    --tenant service

python $DGIS_OPENSTACK_SCRIPTS_PATH/create_service.py \
    --name nova \
    --type compute \
    --description 'OpenStack Compute'

python $DGIS_OPENSTACK_SCRIPTS_PATH/create_service.py \
    --name novav3 \
    --type computev3 \
    --description 'OpenStack Compute'

python $DGIS_OPENSTACK_SCRIPTS_PATH/create_endpoint.py \
    --service-name nova \
    --admin-url "http://{{ getv "/services/balancer/host" }}:8774/v2/%(tenant_id)s" \
    --internal-url "http://{{ getv "/services/balancer/host" }}:8774/v2/%(tenant_id)s" \
    --public-url "http://{{ getv "/services/balancer/host" }}:8774/v2/%(tenant_id)s"

python $DGIS_OPENSTACK_SCRIPTS_PATH/create_endpoint.py \
    --service-name novav3 \
    --admin-url "http://{{ getv "/services/balancer/host" }}:8774/v3" \
    --internal-url "http://{{ getv "/services/balancer/host" }}:8774/v3" \
    --public-url "http://{{ getv "/services/balancer/host" }}:8774/v3"
