#!/usr/bin/env bash
# Generated by confd

source $DGIS_OPENSTACK_SCRIPTS_PATH/common.sh
source /openrc.sh

function openstack_client() {
    local auth_url="$(echo ${OS_SERVICE_ENDPOINT} | sed 's/v2\.0/v3/g')"
    openstack --os-identity-api-version 3 \
                        --os-auth-url $auth_url \
                        --os-username admin \
                        --os-password {{ getv "/services/keystone/config/admin-password" }} \
                        --os-project-name admin \
                        "$@"
}

wait_for_endpoint $OS_SERVICE_ENDPOINT 1 10

# Register user and services
keystone user-create \
    --name {{ getv "/services/heat/config/keystone-user" }} \
    --tenant {{ getv "/services/heat/config/keystone-tenant" }}  \
    --pass {{ getv "/services/heat/config/keystone-password" }}

keystone user-role-add \
    --user {{ getv "/services/heat/config/keystone-user" }} \
    --tenant {{ getv "/services/heat/config/keystone-tenant" }}  \
    --role admin

keystone role-create --name heat_stack_owner

python $DGIS_OPENSTACK_SCRIPTS_PATH/create_service.py \
    --name heat \
    --type orchestration \
    --description "Orchestration"

python $DGIS_OPENSTACK_SCRIPTS_PATH/create_endpoint.py \
    --service-name heat \
    --public-url http://{{ getv "/services/balancer/host" }}:8004/v1/%\(tenant_id\)s \
    --admin-url http://{{ getv "/services/balancer/host" }}:8004/v1/%\(tenant_id\)s \
    --internal-url http://{{ getv "/services/balancer/host" }}:8004/v1/%\(tenant_id\)s

# Check and create domain for heat
openstack_client domain show {{ getv "/services/heat/config/stack-user-domain-name" }} || \
openstack_client domain create --description "Heat domain" {{ getv "/services/heat/config/stack-user-domain-name" }}

# Check and create domain user for heat
openstack_client user show {{ getv "/services/heat/config/stack-user-domain-name" }} | grep -w {{ getv "/services/heat/config/stack-domain-admin" }} || \
openstack_client user create \
    --domain {{ getv "/services/heat/config/stack-user-domain-name" }} \
    --password {{ getv "/services/heat/config/stack-domain-admin-password" }} \
    {{ getv "/services/heat/config/stack-domain-admin" }}

# Assign admin role to heat domain admin user
openstack_client role add \
    --domain {{ getv "/services/heat/config/stack-user-domain-name" }} \
    --user {{ getv "/services/heat/config/stack-domain-admin" }} \
    admin
