#!/usr/bin/env bash
# Generated by confd

source $DGIS_OPENSTACK_SCRIPTS_PATH/common.sh
source /openrc.sh

wait_for_endpoint $OS_SERVICE_ENDPOINT 1 10

if [[ $(keystone tenant-get demo > /dev/null 2>&1) ]]; then
    keystone tenant-create \
        --name demo \
        --enabled true \
        --description 'Demo tenant'
fi

if [[ $(keystone user-get demo > /dev/null 2>&1) ]]; then
    keystone user-create \
        --name demo \
        --tenant demo \
        --pass qweqwe
fi

if [[ $(keystone user-role-list --tenant demo --user demo > /dev/null 2>&1) ]]; then
    keystone user-role-add \
        --user demo \
        --role _member_ \
        --tenant demo

    keystone user-role-add \
        --user demo \
        --role heat_stack_owner \
        --tenant demo

    keystone role-create \
        --name remote_image
fi

if [[ ! -d "/opt/images" ]]; then
    mkdir /opt/images
    curl -sSLo /opt/images/cirros-0.3.4-x86_64-disk.img \
        http://download.cirros-cloud.net/0.3.4/cirros-0.3.4-x86_64-disk.img
fi

if [[ $(glance image-show "b290b37b-76ee-44f4-89ca-b95d85f4f618" > /dev/null 2>&1) ]]; then
    glance image-create --name "cirros" \
        --id b290b37b-76ee-44f4-89ca-b95d85f4f618 \
        --is-public True \
        --disk-format qcow2 \
        --container-format bare \
        --file /opt/images/cirros-0.3.4-x86_64-disk.img
fi

if [[ $(neutron net-show tempest-public > /dev/null 2>&1) ]]; then
    neutron net-create --tenant-id demo tempest-public
fi

if [[ $(neutron subnet-show tempest-public-subnet > /dev/null 2>&1) ]]; then
    neutron subnet-create tempest-public \
        10.0.0.10/24 \
        --name tempest-public-subnet \
        --tenant-id demo
fi

if [[ $(neutron net-show tempest-private > /dev/null 2>&1) ]]; then
    neutron net-create --tenant-id demo tempest-private
fi

if [[ $(neutron subnet-show tempest-private-subnet > /dev/null 2>&1) ]]; then
    neutron subnet-create tempest-private \
        192.168.74.0/24 \
        --name tempest-private-subnet \
        --tenant-id demo
fi

if [[ $(neutron router-show tempest-router > /dev/null 2>&1) ]]; then
    neutron router-create tempest-router --tenant-id demo
    neutron router-interface-add tempest-router tempest-private-subnet
fi

if [[ $(nova flavor-show 201 > /dev/null 2>&1) ]]; then
    nova flavor-create tempest1 201 256 1 1
fi

if [[ $(nova flavor-show 202 > /dev/null 2>&1) ]]; then
    nova flavor-create tempest2 202 512 1 1
fi
